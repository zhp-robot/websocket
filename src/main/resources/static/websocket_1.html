<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>欢迎使用MQTT</title>
    <script src="js/jquery-1.11.0.min.js"></script>
    <script>
        var socket;
        if(typeof(WebSocket) == "undefined") {
            console.log("Your browser not support WebSocket!");
        }else{
            console.log("Your browser support WebSocket");
            // 实例化WebSocket对象
            // 指定要连接的服务器地址与端口
            // 建立连接
            socket = new WebSocket("ws://localhost:8080/websocket", "mqtt");
            // 打开事件
            socket.onopen = function() {
                console.log("You has connect to WebSocketServer");
            };
            // 获得消息事件
            socket.onmessage = function(msg) {
                // 打印接收到的消息
                console.log(msg.data);
            };
            // 关闭事件
            socket.onclose = function() {
                console.log("Socket has closed");
            };
            // 发生了错误事件
            socket.onerror = function() {
                alert("Socket happens an error!");
            }
            //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
            window.onbeforeunload = function() {
                websocket.close();
            }
            function subscribe() {
                var topic = $("#topic").val();
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded;charset=utf-8",
                    url: "http://localhost:8080/websocket/mqtt/subscribe",
                    data: {
                        topic: topic
                    },
                    cache: false,
                    timeout: 600000,
                    success: function (data) {
                        var json = "<pre>" + JSON.stringify(data.data) + "</pre>";
                        $('#logger').html($('#logger').html() + json);
                    },
                    error: function (e) {
                        var json = "<pre>" + e.responseText + "</pre>";
                        $('#logger').html($('#logger').html() + json);
                    }
                });
            }
            function unsubscribe() {
                var topic = $("#topic").val();
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded;charset=utf-8",
                    url: "http://localhost:8080/websocket/mqtt/unsubscribe",
                    data: {
                        topic: topic
                    },
                    cache: false,
                    timeout: 600000,
                    success: function (data) {
                        var json = "<pre>" + JSON.stringify(data.data) + "</pre>";
                        $('#logger').html($('#logger').html() + json);
                    },
                    error: function (e) {
                        var json = "<pre>" + e.responseText + "</pre>";
                        $('#logger').html($('#logger').html() + json);
                    }
                });
            }
            function publishMessage() {
                var topic = $("#publishtopic").val();
                var message = $("#message").val();
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded;charset=utf-8",
                    url: "http://localhost:8080/websocket/mqtt/publish",
                    data: {
                        topic: topic,
                        message: message
                    },
                    cache: false,
                    timeout: 600000,
                    success: function (data) {
                        var json = "<pre>" + JSON.stringify(data.data) + "</pre>";
                        $('#logger').html($('#logger').html() + json);
                    },
                    error: function (e) {
                        var json = "<pre>" + e.responseText + "</pre>";
                        $('#logger').html($('#logger').html() + json);
                    }
                });
            }
        }
    </script>
</head>
<body>
    <input type="text" id="topic" placeholder="订阅/取订主题"/>
    <input type="button" value="订阅主题" onclick="subscribe()"/>
    <input type="button" value="取消订阅" onclick="unsubscribe()"/>
    <input type="text" id="publishtopic" placeholder="发布主题"/>
    <textarea cols="8" rows="10" id="message" placeholder="message..."></textarea>
    <input type="button" value="发送消息" onclick="publishMessage()"/>
    <p id="logger">LOG</p>
</body>
</html>